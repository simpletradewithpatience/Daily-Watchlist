<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Equity Research Dashboard ‚Äî Pro Upgrade</title>
<link rel="preconnect" href="https://cdn.sheetjs.com" />
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<style>
  :root{
    --bg: #0b1221; --panel:#0f172a; --panel-2:#111827; --text:#e5e7eb; --muted:#9ca3af;
    --brand:#60a5fa; --ring: rgba(96,165,250,.35); --good-1:#16a34a; --good-2:#34d399; --warn-1:#f59e0b; --warn-2:#fde047; --bad-1:#ef4444;
    --card-strong-1:#0ea5e9; --card-strong-2:#3b82f6; --card-med-1:#10b981; --card-med-2:#22d3ee; --card-low-1:#f59e0b; --card-low-2:#fbbf24;
    --accent:#22c55e; --danger:#ef4444; --border: rgba(255,255,255,.06); --border-2: rgba(255,255,255,.12);
  }
  /* Light theme overrides */
  [data-theme="light"]{
    --bg:#f7fafc; --panel:#ffffff; --panel-2:#f3f4f6; --text:#0b1221; --muted:#4b5563; --brand:#2563eb; --ring: rgba(37,99,235,.25);
    --card-strong-1:#60a5fa; --card-strong-2:#2563eb; --card-med-1:#34d399; --card-med-2:#22c55e; --card-low-1:#f59e0b; --card-low-2:#fbbf24; --border: rgba(0,0,0,.08); --border-2: rgba(0,0,0,.12);
  }

  *{box-sizing:border-box}
  html, body{height:100%}
  body{margin:0;font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans"; background:linear-gradient(180deg, var(--bg), var(--panel-2) 60%); color:var(--text)}

  header{position:sticky; top:0; z-index:30; backdrop-filter:saturate(120%) blur(10px); background:rgba(11,18,33,.75); border-bottom:1px solid rgba(255,255,255,.05)}
  [data-theme="light"] header{background:rgba(255,255,255,.8)}
  .container{max-width:1200px; margin:0 auto; padding:16px 20px}
  h1{margin:0; font-size:clamp(1.25rem,2vw,1.6rem); letter-spacing:.2px}
  .sub{color:var(--muted); font-size:.9rem; margin-top:4px}

  .row{display:grid; grid-template-columns:1fr; gap:12px}
  @media (min-width: 900px){ .row{grid-template-columns: 2fr 2fr 2fr 2fr 2fr 2fr} }

  .panel{background:linear-gradient(180deg, var(--panel), var(--panel-2)); border:1px solid var(--border); border-radius:14px; padding:10px 12px; box-shadow:0 6px 20px rgba(0,0,0,.1)}

  label{display:block; font-size:.78rem; color:var(--muted); margin-bottom:6px}
  input[type="file"], select, input[type="text"], button{width:100%; padding:10px 12px; background:#0b1328; color:var(--text); border:1px solid var(--border); border-radius:10px; outline:none}
  [data-theme="light"] input[type="file"], [data-theme="light"] select, [data-theme="light"] input[type="text"], [data-theme="light"] button{background:#fff}
  input:focus, select:focus, button:focus{box-shadow:0 0 0 6px var(--ring); border-color:var(--brand)}

  .toolbar{display:grid; gap:12px; grid-template-columns: repeat(2, 1fr)}
  @media (min-width: 720px){ .toolbar{grid-template-columns: repeat(4, 1fr)} }

  .btn{cursor:pointer; transition:transform .12s ease, box-shadow .12s ease}
  .btn:hover{transform:translateY(-1px); box-shadow:0 10px 20px rgba(0,0,0,.25)}
  .btn.primary{background:linear-gradient(135deg, #2563eb, #0284c7); border:none}
  .btn.ghost{background:transparent; border:1px dashed var(--border-2)}
  .btn.success{background:linear-gradient(135deg, #22c55e, #16a34a); border:none}
  .btn.warn{background:linear-gradient(135deg, #f59e0b, #f97316); border:none}

  .legend{display:flex; gap:10px; align-items:center; flex-wrap:wrap; font-size:.85rem; color:var(--muted)}
  .dot{width:12px; height:12px; border-radius:50%; display:inline-block; margin-right:6px}

  .summary{display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:16px; padding:18px 0 28px}
  .listview .summary{grid-template-columns:1fr}

  .card{position:relative; padding:16px 14px 12px; border-radius:16px; background:linear-gradient(135deg, #0b1328, #0d1a38); border:1px solid var(--border); box-shadow:0 10px 30px rgba(0,0,0,.2); transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease; cursor:pointer}
  [data-theme="light"] .card{background:linear-gradient(135deg, #ffffff, #f3f4f6)}
  .card:hover{transform:translateY(-4px); box-shadow:0 16px 40px rgba(0,0,0,.25); border-color:rgba(96,165,250,.35)}

  .card.darkGreen{background:linear-gradient(135deg, var(--card-strong-1), var(--card-strong-2)); color:#fff}
  .card.mediumGreen{background:linear-gradient(135deg, var(--card-med-1), var(--card-med-2)); color:#031016}
  .card.lightGreen{background:linear-gradient(135deg, var(--card-low-1), var(--card-low-2)); color:#1b1405}

  .badge{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:.75rem; font-weight:700; background:rgba(0,0,0,.25); color:#fff; border:1px solid rgba(255,255,255,.25); margin-bottom:8px; transition:transform .15s ease}
  .card:hover .badge{transform:scale(1.06)}

  .stock{display:flex; justify-content:space-between; align-items:baseline; gap:8px}
  .symbol{font-size:1.1rem; font-weight:800; letter-spacing:.3px}
  .pct{font-variant-numeric:tabular-nums; font-weight:700}

  .kv{margin:8px 0 0; display:grid; grid-template-columns:1fr 1fr; gap:6px 10px; font-size:.9rem}
  .kv b{opacity:.8; font-weight:700}
  .note{margin-top:8px; font-size:.86rem; line-height:1.2rem}
  .final{margin-top:6px; font-size:.86rem; font-weight:700}

  .tooltip{position:absolute; top:8px; right:8px; background:rgba(0,0,0,.7); color:#fff; padding:6px 8px; border-radius:8px; font-size:.75rem; display:none; max-width:260px; pointer-events:none}
  .card:hover .tooltip{display:block}

  .meta{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:10px; font-size:.8rem; color:var(--muted)}
  .pill{padding:4px 8px; border-radius:999px; border:1px solid var(--border-2)}

  .empty{padding:28px; text-align:center; color:var(--muted); border:1px dashed var(--border); border-radius:12px}
  .count{font-size:.88rem; color:var(--muted)}

  .kpis{display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:12px}
  @media (min-width:720px){ .kpis{grid-template-columns:repeat(4,1fr)} }
  .kpi{background:rgba(255,255,255,.04); border:1px solid var(--border); border-radius:12px; padding:10px 12px}
  [data-theme="light"] .kpi{background:#fff}
  .kpi b{display:block; font-size:.75rem; color:var(--muted)}
  .kpi .val{font-size:1.1rem; font-weight:800; letter-spacing:.2px}

  .chips{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
  .chip{padding:6px 10px; border-radius:999px; border:1px solid var(--border-2); background:rgba(255,255,255,.03); cursor:pointer; font-size:.82rem}
  .chip.active{outline:3px solid var(--ring); border-color:var(--brand)}

  .dropzone{border:2px dashed rgba(255,255,255,.2); border-radius:12px; padding:18px; text-align:center; color:var(--muted)}
  [data-theme="light"] .dropzone{border-color: rgba(0,0,0,.1)}
  .dropzone.highlight{border-color:var(--brand); background: rgba(96,165,250,.08); color:var(--text)}

  .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:50}
  .modal{width:min(680px,94vw); background:linear-gradient(180deg, var(--panel), var(--panel-2)); border:1px solid var(--border-2); border-radius:16px; padding:18px; box-shadow:0 20px 60px rgba(0,0,0,.5)}
  .modal-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:8px}
  .modal-actions{display:flex; gap:8px; flex-wrap:wrap}

  .toast{position:fixed; right:16px; bottom:16px; background:#0b1328; color:var(--text); padding:10px 12px; border:1px solid var(--border-2); border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,.4); display:none; z-index:60}

  /* Alert accents */
  .alert-high{box-shadow:0 0 0 2px rgba(239,68,68,.6) inset}
  .alert-low{box-shadow:0 0 0 2px rgba(16,185,129,.6) inset}

  /* Sticky filter bar on mobile */
  @media (max-width:720px){
    .sticky-filters{position:sticky; top:62px; z-index:25}
  }
</style>
</head>
<body>
  <header>
    <div class="container">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px">
        <div>
          <h1>Equity Research Dashboard ‚Äî Pro</h1>
          <div class="sub">Clean, clickable stock screens. Built for <b>education + action</b>.</div>
        </div>
        <div style="display:flex; gap:8px; align-items:center">
          <button id="themeToggle" class="btn ghost" title="Toggle Dark/Light">üåó Theme</button>
          <button id="listToggle" class="btn ghost" title="Toggle List/Grid">üóÇÔ∏è View</button>
        </div>
      </div>
      <div style="height:12px"></div>
      <div class="row sticky-filters">
        <div class="panel">
          <label for="fileInput">Upload Data</label>
          <input type="file" id="fileInput" accept=".csv,.xls,.xlsx" />
        </div>
        <div class="panel">
          <label for="sortSelect">Sort by</label>
          <select id="sortSelect">
            <option value="">‚Äî No sorting ‚Äî</option>
            <option value="percentChange">% Change (desc)</option>
            <option value="volX">Volume x (desc)</option>
            <option value="riskReward">Risk/Reward (desc)</option>
            <option value="rsiLow">RSI (oversold first)</option>
            <option value="macdBull">MACD (bullish first)</option>
            <option value="ppl">Potential P&L (desc)</option>
          </select>
        </div>
        <div class="panel">
          <label>Strength (multi-select)</label>
          <div id="strengthChips" class="chips" aria-label="Strength filters"></div>
        </div>
        <div class="panel">
          <label for="searchInput">Search by Symbol</label>
          <input type="text" id="searchInput" placeholder="e.g., TCS, RELIANCE, INFY" />
        </div>
        <div class="panel toolbar">
          <button id="btnExportXLSX" class="btn primary">Export current view (.xlsx)</button>
          <button id="btnExportCSV" class="btn ghost">Export current view (.csv)</button>
        </div>
        <div class="panel toolbar">
          <button id="btnTemplate" class="btn ghost">Download CSV Template</button>
          <button id="btnPersist" class="btn success">Save dataset locally</button>
        </div>
      </div>

      <!-- Quick chips (multi-select) -->
      <div class="chips" id="quickChips" aria-label="Quick filters"></div>

      <div class="kpis" id="kpiStrip" aria-hidden="true" style="display:none"></div>
      <div style="height:6px"></div>
      <div class="legend">
        <span><span class="dot" style="background:var(--card-strong-2)"></span>Strong</span>
        <span><span class="dot" style="background:var(--card-med-2)"></span>Moderate</span>
        <span><span class="dot" style="background:var(--card-low-2)"></span>Low</span>
        <span class="count" id="countTxt">No data loaded</span>
        <span style="margin-left:auto; display:flex; gap:8px">
          <button id="btnDemo" class="btn warn" title="Load demo dataset">üéØ Demo Data</button>
          <button id="btnReset" class="btn ghost" title="Reset all controls">‚ôªÔ∏è Reset</button>
        </span>
      </div>
    </div>
  </header>

  <main class="container" id="main">
    <div id="dropZone" class="dropzone" role="region" aria-label="Drop a CSV or Excel file here">Drop CSV/XLSX here or press <b>Ctrl/Cmd+V</b> to paste</div>
    <div id="summaryContainer" class="summary"></div>
    <div id="emptyState" class="empty">Drop a file above to get started. Expected columns include: <b>symbol, close, % change, vol x, rsi, macd, cci, stochastic, go long above, stop loss, lot size</b>. Other columns are shown in a tooltip.</div>
  </main>

  <!-- Modal -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modal-header">
        <div>
          <div id="mSymbol" style="font-weight:900; font-size:1.2rem"></div>
          <div id="mSubtitle" style="color:var(--muted); font-size:.85rem"></div>
        </div>
        <button id="mClose" class="btn ghost" aria-label="Close">Close</button>
      </div>
      <div id="mBody"></div>
      <div style="height:10px"></div>
      <div class="modal-actions">
        <button id="mCopyPlan" class="btn primary">Copy Trade Plan</button>
        <button id="mWatch" class="btn success">Add to Watchlist</button>
        <button id="mRemoveWatch" class="btn ghost" style="display:none">Remove from Watchlist</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
(function(){
  const fileInput = document.getElementById('fileInput');
  const summaryContainer = document.getElementById('summaryContainer');
  const sortSelect = document.getElementById('sortSelect');
  const searchInput = document.getElementById('searchInput');
  const emptyState = document.getElementById('emptyState');
  const btnExportXLSX = document.getElementById('btnExportXLSX');
  const btnExportCSV = document.getElementById('btnExportCSV');
  const btnReset = document.getElementById('btnReset');
  const btnTemplate = document.getElementById('btnTemplate');
  const btnPersist = document.getElementById('btnPersist');
  const btnDemo = document.getElementById('btnDemo');
  const countTxt = document.getElementById('countTxt');
  const dropZone = document.getElementById('dropZone');
  const kpiStrip = document.getElementById('kpiStrip');
  const quickChips = document.getElementById('quickChips');
  const strengthChips = document.getElementById('strengthChips');
  const themeToggle = document.getElementById('themeToggle');
  const listToggle = document.getElementById('listToggle');

  const modalBackdrop = document.getElementById('modalBackdrop');
  const mSymbol = document.getElementById('mSymbol');
  const mSubtitle = document.getElementById('mSubtitle');
  const mBody = document.getElementById('mBody');
  const mClose = document.getElementById('mClose');
  const mCopyPlan = document.getElementById('mCopyPlan');
  const mWatch = document.getElementById('mWatch');
  const mRemoveWatch = document.getElementById('mRemoveWatch');
  const toast = document.getElementById('toast');
  const main = document.getElementById('main');

  let allData = [];
  let currentData = [];
  let watchlist = new Set(JSON.parse(localStorage.getItem('eqdash_watchlist')||'[]'));

  const hiddenColumns = ['sector','marketcap name','vol x','rsi','macd','cci','stochastic','vwap','suprt trend'];
  const nf = new Intl.NumberFormat(undefined, { maximumFractionDigits: 2 });

  // THEME
  const themeKey='eqdash_theme_v1';
  try{ const t = localStorage.getItem(themeKey); if(t){ document.documentElement.setAttribute('data-theme', t); } }catch(e){}
  themeToggle.addEventListener('click', ()=>{
    const cur = document.documentElement.getAttribute('data-theme')==='light'?'light':'dark';
    const next = cur==='light'?'dark':'light';
    document.documentElement.setAttribute('data-theme', next);
    try{ localStorage.setItem(themeKey, next);}catch(e){}
  });

  // LIST/GRID
  const viewKey='eqdash_view_v1';
  try{ if(localStorage.getItem(viewKey)==='list'){ main.classList.add('listview'); } }catch(e){}
  listToggle.addEventListener('click', ()=>{
    main.classList.toggle('listview');
    try{ localStorage.setItem(viewKey, main.classList.contains('listview')?'list':'grid'); }catch(e){}
  });

  // Persist controls across reloads (no data pre-load other than user's persisted dataset ‚Äî no calculators)
  const stateKey = 'eqdash_state_v4';
  function saveState(){
    const s = { sort: sortSelect.value, search: searchInput.value, quick: getActiveQuickChipIds(), strength: getActiveStrengths() };
    localStorage.setItem(stateKey, JSON.stringify(s));
  }
  function loadState(){
    try{
      const s = JSON.parse(localStorage.getItem(stateKey) || '{}');
      if(s.sort) sortSelect.value = s.sort;
      if(s.search) searchInput.value = s.search;
    }catch(e){}
  }
  loadState();

  function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn.apply(null,args), ms); }; }

  // Keyboard shortcuts
  window.addEventListener('keydown', (e)=>{
    if(e.key==='/' && document.activeElement !== searchInput){ e.preventDefault(); searchInput.focus(); }
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='e'){ e.preventDefault(); exportXLSX(); }
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='r'){ e.preventDefault(); resetControls(); }
  });

  // File handling
  fileInput.addEventListener('change', function(){ const file = this.files && this.files[0]; if(!file) return; readFile(file); });

  // Drag & Drop
  ;['dragenter','dragover'].forEach(ev=> dropZone.addEventListener(ev, (e)=>{ e.preventDefault(); dropZone.classList.add('highlight'); }));
  ;['dragleave','drop'].forEach(ev=> dropZone.addEventListener(ev, (e)=>{ e.preventDefault(); if(ev==='drop'){ const f=e.dataTransfer.files[0]; if(f) readFile(f); } dropZone.classList.remove('highlight'); }));

  // Paste CSV
  window.addEventListener('paste', (e)=>{
    const txt = e.clipboardData && e.clipboardData.getData('text');
    if(txt && /,|\n/.test(txt)){
      try { processCSV(txt); showToast('Pasted CSV data'); } catch(err){ showToast('Paste failed'); }
    }
  });

  function readFile(file){
    const reader = new FileReader();
    reader.onerror = () => alert('Failed to read file. Please try again.');
    reader.onload = (e) => {
      try {
        if(/\.csv$/i.test(file.name)) processCSV(e.target.result);
        else processSheet(new Uint8Array(e.target.result));
        showToast('Loaded: ' + file.name);
      } catch(err){ console.error(err); alert('Could not parse file. Ensure headers are present.'); }
    };
    if(/\.csv$/i.test(file.name)) reader.readAsText(file); else reader.readAsArrayBuffer(file);
  }

  function processSheet(arr){
    const wb = XLSX.read(arr, { type: 'array' });
    const sheet = wb.SheetNames[0];
    const ws = wb.Sheets[sheet];
    const json = XLSX.utils.sheet_to_json(ws, { defval: '' });
    processData(json);
  }

  function processCSV(csv){
    const rows = csv.split(/\r?\n/).filter(Boolean);
    const parse = (line)=>{ const out = []; let cur = '', q = false; for(let i=0;i<line.length;i++){ const ch=line[i]; if(ch==='"'){ q=!q; continue;} if(ch===',' && !q){ out.push(cur); cur=''; } else { cur += ch; } } out.push(cur); return out; };
    const headers = parse(rows[0]).map(h=>h.trim());
    const data = rows.slice(1).map(r=>{ const cols = parse(r); const obj = {}; headers.forEach((h,i)=>{ obj[h.trim().toLowerCase()] = (cols[i]||'').toString().trim(); }); return obj; });
    processData(data);
  }

  function toNum(val){ const n = typeof val === 'number' ? val : parseFloat(String(val).replace(/[%,$\s]/g,'')); return Number.isFinite(n) ? n : 0; }

  function processData(data){
    let invalid = 0;
    const processed = [];

    data.forEach(row=>{
      const lower = {}; Object.keys(row).forEach(k=> lower[k.toLowerCase()] = row[k]);
      if(!lower.symbol || (!lower.close && lower.close!==0)){ invalid++; return; }

      Object.keys(lower).forEach(k=>{
        const v = toNum(lower[k]);
        if(!Number.isNaN(v) && /%|change|vol x|rsi|macd|cci|stochastic|close|open|high|low|stop loss|go long above|lot size|volume|riskreward|potentialpl|risk/.test(k)){
          lower[k] = v;
        }
      });

      if('go long above' in lower && 'stop loss' in lower) lower.risk = +(toNum(lower['go long above']) - toNum(lower['stop loss'])).toFixed(2);
      if('close' in lower && 'stop loss' in lower) lower.riskreward = +(((toNum(lower.close) - toNum(lower['stop loss']))/Math.max(1,toNum(lower.close)))*100).toFixed(2);
      if('close' in lower && 'stop loss' in lower && 'lot size' in lower) lower.potentialpl = +((toNum(lower.close) - toNum(lower['stop loss']))*toNum(lower['lot size'])).toFixed(2);

      if('go long above' in lower && 'stop loss' in lower){ const entry = toNum(lower['go long above']); const sl = toNum(lower['stop loss']); const R = Math.max(0.01, entry - sl); lower.target1 = +(entry + 1*R).toFixed(2); lower.target2 = +(entry + 2*R).toFixed(2); lower.rMultiple = R; }

      let score = 0;
      if('% change' in lower && toNum(lower['% change']) > 2) score++;
      if('vol x' in lower && toNum(lower['vol x']) > 1) score++;
      if('rsi' in lower && toNum(lower.rsi) > 30 && toNum(lower.rsi) < 70) score++;
      lower.cardClass = score >= 3 ? 'darkGreen' : (score === 2 ? 'mediumGreen' : 'lightGreen');

      const notes = [];
      if('rsi' in lower){ const r = toNum(lower.rsi); if(r > 70) notes.push(`<span><b>RSI high</b> ‚Üí overbought</span>`); else if(r < 30) notes.push(`<span><b>RSI low</b> ‚Üí possible accumulation</span>`); else notes.push(`<span>RSI neutral</span>`); }
      if('vol x' in lower){ const vx = toNum(lower['vol x']); notes.push(vx > 1 ? `<span><b>Strong volume</b> ‚Üí momentum</span>` : (vx > .5 ? `<span>Avg volume</span>` : `<span>Low volume</span>`)); }
      if('% change' in lower && toNum(lower['% change']) > 2) notes.push(`<span>Price advancing ‚Üí trend setup</span>`);
      if('risk' in lower && 'potentialpl' in lower) notes.push(`<span><b>Risk:</b> ${nf.format(lower.risk)}, <b>P&L:</b> ${nf.format(lower.potentialpl)}</span>`);
      if('macd' in lower) notes.push(`<span>MACD: ${toNum(lower.macd) > 0 ? 'bullish' : 'bearish'}</span>`);
      if('cci' in lower){ const c = toNum(lower.cci); notes.push(`<span>CCI: ${c>100?'overbought':c<-100?'oversold':'neutral'}</span>`); }
      if('stochastic' in lower) notes.push(`<span>Stochastic: ${nf.format(toNum(lower.stochastic))}</span>`);
      lower.note = notes.join('<br>');

      const macd = toNum(lower.macd); const rsi = toNum(lower.rsi); const close = Math.max(1, toNum(lower.close)); const riskAbs = Math.abs(toNum(lower.risk));
      lower.finalOutlook = (()=>{ const momentum = lower.cardClass === 'darkGreen' ? 'Strong' : (lower.cardClass === 'mediumGreen' ? 'Moderate' : 'Low'); const trend = (macd > 0 && rsi < 70) ? 'Bullish' : (macd < 0 && rsi > 30) ? 'Bearish' : 'Neutral'; const riskLevel = riskAbs > close*0.05 ? 'High' : 'Low'; const vol = toNum(lower['vol x']); const volTrend = vol > 1 ? 'High' : (vol > .5 ? 'Moderate' : 'Low'); return `Momentum: ${momentum}, Trend: ${trend}, Risk: ${riskLevel}, Volume: ${volTrend}`; })();

      processed.push(lower);
    });

    if(invalid){ showToast(`Skipped ${invalid} row(s): missing symbol/close`); }

    allData = processed; currentData = [...allData];
    renderKpis(currentData);
    buildStrengthChips();
    buildQuickChips();
    applyFilterSortSearch();
  }

  function renderCards(data){
    if(!data.length){ summaryContainer.innerHTML=''; emptyState.style.display='block'; countTxt.textContent='0 matches'; kpiStrip.style.display='none'; return; }
    emptyState.style.display='none';

    const html = data.map(stock=>{
      const badgeText = stock.cardClass === 'darkGreen' ? 'Strong' : (stock.cardClass === 'mediumGreen' ? 'Moderate' : 'Low');
      let tooltip = '';
      hiddenColumns.forEach(col=>{ if(col in stock) tooltip += `<strong>${escapeHtml(col)}:</strong> ${escapeHtml(stock[col])}<br>`; });

      const visible = Object.keys(stock).filter(k=>!['cardclass','note','finaloutlook','rmultiple'].includes(k.toLowerCase()) && !hiddenColumns.includes(k.toLowerCase()) && !['symbol'].includes(k.toLowerCase())).slice(0,8);
      const pct = ('% change' in stock) ? `${nf.format(toNum(stock['% change']))}%` : '';
      const inWatch = watchlist.has(String(stock.symbol||'').toUpperCase());

      // alerts
      const alerts = [];
      if(toNum(stock.rsi) > 70) alerts.push('alert-high');
      if(toNum(stock.rsi) < 30) alerts.push('alert-low');
      const alertClass = alerts.join(' ');

      const bell = toNum(stock['% change']) > 5 ? ' üîî' : '';

      return `<div class="card ${stock.cardClass} ${alertClass}" role="button" tabindex="0" data-symbol="${escapeAttr(stock.symbol||'')}" aria-label="${escapeAttr(stock.symbol||'')} stock card">
        <span class="badge" aria-hidden="true">${badgeText}${inWatch?' ‚Ä¢ ‚òÖ':''}${bell}</span>
        <div class="stock">
          <div class="symbol">${escapeHtml(stock.symbol || '')}</div>
          <div class="pct">${pct}</div>
        </div>
        <div class="kv">
          ${visible.map(k=>`<div><b>${escapeHtml(k)}:</b> ${fmtVal(stock[k])}</div>`).join('')}
        </div>
        ${('target1' in stock)? `<div class="note"><b>Targets:</b> T1 ${fmtVal(stock.target1)}, T2 ${fmtVal(stock.target2)}</div>`:''}
        <div class="note">${stock.note}</div>
        <div class="final">Final Outlook: ${stock.finalOutlook}</div>
        <div class="tooltip">${tooltip}</div>
        <div class="meta">
          <span class="pill">Risk/Reward: ${('riskreward' in stock)? nf.format(stock.riskreward): '‚Äî'}</span>
          <span class="pill">Vol x: ${('vol x' in stock)? nf.format(toNum(stock['vol x'])): '‚Äî'}</span>
        </div>
      </div>`;
    }).join('');

    summaryContainer.innerHTML = html;
    countTxt.textContent = `${data.length} match${data.length===1?'':'es'}`;
    kpiStrip.style.display = 'grid';

    Array.from(summaryContainer.querySelectorAll('.card')).forEach(card=>{
      card.addEventListener('click', ()=> openModal(card.getAttribute('data-symbol')));
      card.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); openModal(card.getAttribute('data-symbol')); } });
    });
  }

  function escapeHtml(v){ return String(v==null?'':v).replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s])); }
  function escapeAttr(v){ return escapeHtml(v).replace(/"/g,'&quot;'); }
  function fmtVal(v){ if(typeof v === 'number') return nf.format(v); const num = toNum(v); if(Number.isFinite(num) && String(v).match(/^[\d\s.,%$-]+$/)) return nf.format(num); return escapeHtml(v); }

  function applyFilterSortSearch(){
    let data = [...allData];

    // Multi-select strengths
    const strengths = getActiveStrengths();
    if(strengths.length){ data = data.filter(d=> strengths.includes(d.cardClass)); }

    // Multi-select quick chips (AND all active)
    const activeQuick = getActiveQuickChips();
    if(activeQuick.length){ activeQuick.forEach(def=>{ data = data.filter(def.fn); }); }

    // search
    const q = searchInput.value.trim().toLowerCase();
    if(q) data = data.filter(d => String(d.symbol||'').toLowerCase().includes(q));

    // sort
    const s = sortSelect.value;
    if(s === 'percentChange') data.sort((a,b)=> toNum(b['% change']) - toNum(a['% change']));
    else if(s === 'volX') data.sort((a,b)=> toNum(b['vol x']) - toNum(a['vol x']));
    else if(s === 'riskReward') data.sort((a,b)=> toNum(b.riskreward) - toNum(a.riskreward));
    else if(s === 'rsiLow') data.sort((a,b)=> toNum(a.rsi) - toNum(b.rsi));
    else if(s === 'macdBull') data.sort((a,b)=> toNum(b.macd) - toNum(a.macd));
    else if(s === 'ppl') data.sort((a,b)=> toNum(b.potentialpl) - toNum(a.potentialpl));

    currentData = data;
    renderKpis(currentData);
    renderCards(currentData);
    saveState();
  }

  sortSelect.addEventListener('change', applyFilterSortSearch);
  searchInput.addEventListener('input', debounce(applyFilterSortSearch, 150));

  // Exporters
  function exportXLSX(){
    if(!currentData.length){ alert('Nothing to export yet.'); return; }
    const rows = toExportRows(currentData);
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Screened');
    const fname = `screened_${new Date().toISOString().slice(0,10)}.xlsx`;
    XLSX.writeFile(wb, fname);
  }
  function exportCSV(){
    if(!currentData.length){ alert('Nothing to export yet.'); return; }
    const rows = toExportRows(currentData);
    const ws = XLSX.utils.json_to_sheet(rows);
    const csv = XLSX.utils.sheet_to_csv(ws);
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=`screened_${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(url);
  }
  function toExportRows(data){
    return data.map(o=>({
      Symbol: o.symbol || '', Close: o.close ?? '', PercentChange: o['% change'] ?? '', Volume: o.volume ?? '', Volume20SMA: o['volume 20 sma'] ?? '', VolX: o['vol x'] ?? '', RSI: o.rsi ?? '', MACD: o.macd ?? '', CCI: o.cci ?? '', Stochastic: o.stochastic ?? '', Risk: o.risk ?? '', RiskRewardPct: o.riskreward ?? '', PotentialPL: o.potentialpl ?? '', Entry: o['go long above'] ?? '', StopLoss: o['stop loss'] ?? '', Target1: o.target1 ?? '', Target2: o.target2 ?? '', FinalOutlook: o.finalOutlook || ''
    }));
  }
  btnExportXLSX.addEventListener('click', exportXLSX);
  btnExportCSV.addEventListener('click', exportCSV);

  function resetControls(){
    sortSelect.value = '';
    searchInput.value = '';
    quickChips.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
    strengthChips.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));

  // Clear persisted filter/sort state
    try { localStorage.removeItem('eqdash_state_v4'); } catch(e) {}

  // üîë Also clear data
    allData = [];
    currentData = [];
    summaryContainer.innerHTML = '';
    emptyState.style.display = 'block';
    countTxt.textContent = 'No data loaded';
    kpiStrip.style.display = 'none';
}


  btnReset.addEventListener('click', resetControls);

  // CSV Template
  btnTemplate.addEventListener('click', ()=>{
    const headers = ['symbol','close','% change','vol x','rsi','macd','cci','stochastic','go long above','stop loss','lot size'];
    const ws = XLSX.utils.aoa_to_sheet([headers, ['TCS', 3850, 1.2, 0.8, 54, 0.3, 45, 70, 3900, 3780, 300]]);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Template');
    XLSX.writeFile(wb, 'eqdash_template.csv');
  });

  // Persist dataset locally (for quick reloads). Not auto-loading demo. (We still allow reloading user's persisted dataset.)
  btnPersist.addEventListener('click', ()=>{ if(!allData.length){ showToast('Load some data first'); return; } try{ localStorage.setItem('eqdash_dataset', JSON.stringify(allData).slice(0, 2_000_000)); showToast('Saved dataset locally'); }catch(e){ showToast('Could not save (too large)'); } });
  try { const persisted = localStorage.getItem('eqdash_dataset'); if(persisted){ allData = JSON.parse(persisted); currentData = [...allData]; renderKpis(currentData); buildStrengthChips(); buildQuickChips(); applyFilterSortSearch(); } } catch(e){}

  function percentile(arr, p){ if(!arr.length) return 0; const a=[...arr].sort((x,y)=>x-y); const i=(p/100)*(a.length-1); const lo=Math.floor(i), hi=Math.ceil(i); if(lo===hi) return a[lo]; return a[lo]+(a[hi]-a[lo])*(i-lo); }
  function avg(arr){ return arr.length? arr.reduce((a,b)=>a+b,0)/arr.length : 0; }

  function renderKpis(data){
    const pct = data.map(d=> toNum(d['% change'])).filter(Number.isFinite);
    const rsi = data.map(d=> toNum(d.rsi)).filter(Number.isFinite);
    const vol = data.map(d=> toNum(d['vol x'])).filter(Number.isFinite);

    const items = [ { label:'Total Symbols', val: data.length }, { label:'Avg % Change', val: nf.format(avg(pct)) + '%' }, { label:'Median RSI', val: nf.format(percentile(rsi, 50)) }, { label:'Avg Vol x', val: nf.format(avg(vol)) } ];
    kpiStrip.innerHTML = items.map(i=>`<div class="kpi"><b>${i.label}</b><div class="val">${i.val}</div></div>`).join('');
  }

  // Strength multi-select chips
  function buildStrengthChips(){
    strengthChips.innerHTML = '';
    const defs = [
      {id:'darkGreen', label:'Strong'},
      {id:'mediumGreen', label:'Moderate'},
      {id:'lightGreen', label:'Low'},
    ];
    defs.forEach(def=>{
      const el = document.createElement('button');
      el.className='chip'; el.textContent = def.label; el.dataset.id = def.id;
      el.addEventListener('click', ()=>{ el.classList.toggle('active'); applyFilterSortSearch(); });
      strengthChips.appendChild(el);
    });
  }
  function getActiveStrengths(){ return Array.from(strengthChips.querySelectorAll('.chip.active')).map(c=>c.dataset.id); }

  // Quick chips (multi-select AND)
  const quickDefs = [
    { id:'breakout', label:'Breakout: %chg>2 & Vol>1 & MACD>0', fn: d=> toNum(d['% change'])>2 && toNum(d['vol x'])>1 && toNum(d.macd)>0 },
    { id:'pullback', label:'Healthy Pullback: RSI 40‚Äì60', fn: d=> toNum(d.rsi)>=40 && toNum(d.rsi)<=60 },
    { id:'value', label:'Low Momentum (scan)', fn: d=> d.cardClass==='lightGreen' },
    { id:'watch', label:'‚òÖ Watchlist only', fn: d=> watchlist.has(String(d.symbol||'').toUpperCase()) },
  ];
  function buildQuickChips(){ quickChips.innerHTML = ''; quickDefs.forEach(def=>{ const el=document.createElement('button'); el.className='chip'; el.textContent=def.label; el.dataset.id=def.id; el.addEventListener('click', ()=>{ el.classList.toggle('active'); applyFilterSortSearch(); }); quickChips.appendChild(el); }); }
  function getActiveQuickChips(){ return Array.from(quickChips.querySelectorAll('.chip.active')).map(c=> quickDefs.find(q=>q.id===c.dataset.id)); }
  function getActiveQuickChipIds(){ return Array.from(quickChips.querySelectorAll('.chip.active')).map(c=> c.dataset.id); }

  // Demo data (on click only)
  btnDemo.addEventListener('click', ()=>{
    const demo = [
      { symbol:'TCS', close:3850, '% change':1.2, 'vol x':0.8, rsi:54, macd:0.3, cci:45, stochastic:70, 'go long above':3900, 'stop loss':3780, 'lot size':300 },
      { symbol:'RELIANCE', close:2940, '% change':2.8, 'vol x':1.3, rsi:62, macd:0.7, cci:120, stochastic:65, 'go long above':2970, 'stop loss':2880, 'lot size':250 },
      { symbol:'INFY', close:1580, '% change':-0.6, 'vol x':0.4, rsi:35, macd:-0.2, cci:-130, stochastic:30, 'go long above':1605, 'stop loss':1540, 'lot size':500 },
      { symbol:'HDFCBANK', close:1650, '% change':5.6, 'vol x':1.6, rsi:72, macd:0.9, cci:160, stochastic:80, 'go long above':1670, 'stop loss':1600, 'lot size':550 },
      { symbol:'ICICIBANK', close:1025, '% change':3.1, 'vol x':1.1, rsi:58, macd:0.2, cci:75, stochastic:55, 'go long above':1038, 'stop loss':995, 'lot size':700 }
    ];
    processData(demo);
    showToast('Demo data loaded');
  });

  // Modal logic
  function openModal(symbol){
    const s = String(symbol||'').toLowerCase();
    const row = allData.find(r=> String(r.symbol||'').toLowerCase()===s);
    if(!row) return;
    mSymbol.textContent = row.symbol || '';
    mSubtitle.textContent = row.finalOutlook || '';

    const entry = toNum(row['go long above']);
    const sl = toNum(row['stop loss']);
    const r = Math.max(0.01, entry - sl);
    const t1 = ('target1' in row) ? row.target1 : +(entry + r).toFixed(2);
    const t2 = ('target2' in row) ? row.target2 : +(entry + 2*r).toFixed(2);

    const wStar = watchlist.has(String(row.symbol||'').toUpperCase());
    mWatch.style.display = wStar ? 'none':'inline-block';
    mRemoveWatch.style.display = wStar ? 'inline-block':'none';

    const capital = 100000; // example for display; could be user-configurable later
    const riskPct = 1; // 1% risk model
    const perTradeRisk = capital * (riskPct/100);
    const perShareRisk = r || 1;
    const positionSize = Math.max(1, Math.floor(perTradeRisk / perShareRisk));
    const maxLoss = positionSize * perShareRisk;
    const maxGainT1 = positionSize * Math.max(0, t1 - entry);

    mBody.innerHTML = `
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap:10px">
        <div class="kpi"><b>Entry</b><div class="val">${fmtVal(entry)}</div></div>
        <div class="kpi"><b>Stop Loss</b><div class="val">${fmtVal(sl)}</div></div>
        <div class="kpi"><b>Target 1</b><div class="val">${fmtVal(t1)}</div></div>
        <div class="kpi"><b>Target 2</b><div class="val">${fmtVal(t2)}</div></div>
        <div class="kpi"><b>R (per share)</b><div class="val">${fmtVal(r)}</div></div>
        <div class="kpi"><b>Risk/Reward%</b><div class="val">${fmtVal(row.riskreward||0)}%</div></div>
        <div class="kpi"><b>Pos Size@1% of 1L</b><div class="val">${fmtVal(positionSize)}</div></div>
        <div class="kpi"><b>Max Loss</b><div class="val">${fmtVal(maxLoss)}</div></div>
        <div class="kpi"><b>Est. Gain@T1</b><div class="val">${fmtVal(maxGainT1)}</div></div>
      </div>
      <div style="margin-top:10px; color:var(--muted)">MACD: ${fmtVal(row.macd)} ‚Ä¢ RSI: ${fmtVal(row.rsi)} ‚Ä¢ Vol x: ${fmtVal(row['vol x'])}</div>
    `;

    mCopyPlan.onclick = ()=>{
      const plan = `${row.symbol}\nEntry: ${entry}\nSL: ${sl}\nT1: ${t1}\nT2: ${t2}\nNotes: ${row.finalOutlook}`;
      navigator.clipboard.writeText(plan).then(()=> showToast('Trade plan copied'));
    };

    mWatch.onclick = ()=>{ watchlist.add(String(row.symbol||'').toUpperCase()); persistWatch(); showToast('Added to Watchlist'); mWatch.style.display='none'; mRemoveWatch.style.display='inline-block'; renderCards(currentData); };
    mRemoveWatch.onclick = ()=>{ watchlist.delete(String(row.symbol||'').toUpperCase()); persistWatch(); showToast('Removed from Watchlist'); mWatch.style.display='inline-block'; mRemoveWatch.style.display='none'; renderCards(currentData); };

    modalBackdrop.style.display = 'flex'; modalBackdrop.setAttribute('aria-hidden', 'false');
  }
  mClose.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', (e)=>{ if(e.target===modalBackdrop) closeModal(); });
  function closeModal(){ modalBackdrop.style.display='none'; modalBackdrop.setAttribute('aria-hidden','true'); }
  function persistWatch(){ localStorage.setItem('eqdash_watchlist', JSON.stringify(Array.from(watchlist))); }

  function showToast(msg){ toast.textContent = msg; toast.style.display='block'; clearTimeout(showToast._t); showToast._t = setTimeout(()=> toast.style.display='none', 2000); }

})();
</script>
</body>
</html>
